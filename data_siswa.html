<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Data Siswa</title>
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="index.html" class="nav-link">Home</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Contact</a>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href="#" role="button" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->
  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="index.html" class="brand-link">
      <img src="dist/img/AdminLTELogo.png" alt="ePKL Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">ePKL v2</span>
    </a>
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
          <li class="nav-item">
            <a href="index.html" class="nav-link">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="data_siswa.html" class="nav-link active">
              <i class="nav-icon fas fa-users"></i>
              <p>Data Siswa</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="perusahaan.html" class="nav-link">
              <i class="nav-icon fas fa-building"></i>
              <p>Data Tempat PKL</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="data_presensi.html" class="nav-link">
              <i class="nav-icon fas fa-calendar-check"></i>
              <p>Data Presensi</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="guru_pembimbing.html" class="nav-link">
              <i class="nav-icon fas fa-chalkboard-teacher"></i>
              <p>Data Guru Pembimbing</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-folder"></i>
              <p>Data Other 1</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-folder-open"></i>
              <p>Data Other 2</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>
  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Data Siswa</h1>
          </div>
        </div>
      </div>
    </section>
    <section class="content">
      <div class="container-fluid">
        <h2>Data Siswa</h2>
        <div class="form-inline mb-3">
          <input type="text" id="filterNamaSiswa" class="form-control mr-2" placeholder="Filter Nama Siswa..." style="min-width:200px;">
          <select id="filterGuruPembimbing" class="form-control mr-2"><option value="">ALL Guru Pembimbing</option></select>
          <select id="filterKelas" class="form-control mr-2"><option value="">ALL Kelas</option></select>
          <select id="filterIndustri" class="form-control mr-2"><option value="">ALL Pembimbing Industri</option></select>
          <a href="tambah_siswa.html" class="btn btn-primary ml-2 mb-2">
            <i class="fas fa-plus"></i> Tambah Data
          </a>
          <a href="import_excel_siswa.html" class="btn btn-success ml-2 mb-2">
            <i class="fas fa-file-excel"></i> Import Excel
          </a>
          <button type="button" class="btn btn-warning ml-2 mb-2" id="exportExcel">
            <i class="fas fa-file-export"></i> Export Excel
          </button>
          <button type="button" class="btn btn-secondary ml-2 mb-2" id="refreshData">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button type="button" class="btn btn-danger ml-2 mb-2" id="deleteSelected">
            <i class="fas fa-trash"></i> Hapus Terpilih
          </button>
        </div>
        <div class="table-responsive">
          <div id="siswaTableContainer"></div>
        </div>
      </div>
    </section>
  </div>
  <footer class="main-footer">
    <strong>Copyright &copy; 2025 <a href="#">SMKN 1 Kawunganten</a>.</strong>
    All rights reserved.
    <div class="float-right d-none d-sm-inline-block">
      <b>By</b> Wendra Bagas Saputra
    </div>
  </footer>
</div>
<!-- ./wrapper -->
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<!-- Bootstrap 4 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- DataTables Bootstrap4 (opsional, jika ingin style bootstrap) -->
<script src="plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<!-- AdminLTE App -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDW5b9av9cBHh5AqEnxicBMIP0me-Goy_I",
  authDomain: "epkl-c628b.firebaseapp.com",
  projectId: "epkl-c628b",
  storageBucket: "epkl-c628b.firebasestorage.app",
  messagingSenderId: "41559318468",
  appId: "1:41559318468:web:3711f4da0f7087d683ce91",
  measurementId: "G-ZFWBRF40KQ"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// Load data
function loadData() {
  const tableContainer = document.getElementById('siswaTableContainer');
  // Simpan value filter sebelum reload
  const filterNamaVal = document.getElementById('filterNamaSiswa').value;
  const filterGuruVal = document.getElementById('filterGuruPembimbing').value;
  const filterKelasVal = document.getElementById('filterKelas').value;
  const filterIndustriVal = document.getElementById('filterIndustri').value;
  tableContainer.innerHTML = 'Loading...';
  db.collection("siswa").get().then((querySnapshot) => {
    const guruSet = new Set();
    const kelasSet = new Set();
    const industriSet = new Set();
    const rows = [];
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      guruSet.add(data.namaGuruPembimbing || '-');
      kelasSet.add(data.kelas || '-');
      industriSet.add(data.namaPembimbingIndustri || '-');
      rows.push({
        id: doc.id,
        nis: data.nis || '-',
        namaLengkap: data.namaLengkap || '-',
        kelas: data.kelas || '-',
        namaPerusahaan: data.namaPerusahaan || '-',
        namaGuruPembimbing: data.namaGuruPembimbing || '-',
        namaPembimbingIndustri: data.namaPembimbingIndustri || '-',
        password: data.password || '-'
      });
    });
    // Isi filter select
    const guruSelect = document.getElementById('filterGuruPembimbing');
    const kelasSelect = document.getElementById('filterKelas');
    const industriSelect = document.getElementById('filterIndustri');
    guruSelect.innerHTML = '<option value="">ALL Guru Pembimbing</option>' + Array.from(guruSet).sort().map(g => `<option value="${g}">${g}</option>`).join('');
    kelasSelect.innerHTML = '<option value="">ALL Kelas</option>' + Array.from(kelasSet).sort().map(k => `<option value="${k}">${k}</option>`).join('');
    industriSelect.innerHTML = '<option value="">ALL Pembimbing Industri</option>' + Array.from(industriSet).sort().map(i => `<option value="${i}">${i}</option>`).join('');
    // Set value filter setelah reload
    document.getElementById('filterNamaSiswa').value = filterNamaVal;
    document.getElementById('filterGuruPembimbing').value = filterGuruVal;
    document.getElementById('filterKelas').value = filterKelasVal;
    document.getElementById('filterIndustri').value = filterIndustriVal;
    // Build table HTML
    let tableHtml = '<table id="siswaTable" class="display table table-bordered table-striped" style="width:100%"><thead><tr>' +
      '<th><input type="checkbox" id="selectAll"></th>' +
      '<th>NIS</th>' +
      '<th>Nama Lengkap</th>' +
      '<th>Kelas</th>' +
      '<th>Nama Perusahaan</th>' +
      '<th>Nama Guru Pembimbing</th>' +
      '<th>Nama Pembimbing Industri</th>' +
      '<th>Password</th>' +
      '<th>Action</th>' +
      '</tr></thead><tbody>';
    rows.forEach(row => {
      tableHtml += `<tr>
        <td><input type="checkbox" class="rowCheckbox" data-id="${row.id}"></td>
        <td>${row.nis}</td>
        <td>${row.namaLengkap}</td>
        <td>${row.kelas}</td>
        <td>${row.namaPerusahaan}</td>
        <td>${row.namaGuruPembimbing}</td>
        <td>${row.namaPembimbingIndustri}</td>
        <td>${row.password}</td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editData('${row.id}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteData('${row.id}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>`;
    });
    tableHtml += '</tbody></table>';
    tableContainer.innerHTML = tableHtml;
    // Initialize DataTable (setelah tabel ada di DOM)
    if ($.fn.DataTable && $.fn.DataTable.isDataTable('#siswaTable')) {
      $('#siswaTable').DataTable().destroy();
    }
    var dt = $('#siswaTable').DataTable({
      "responsive": true,
      "autoWidth": false,
      "scrollX": true,
      "pageLength": 25,
      "order": [],
      "columnDefs": [
        { "orderable": false, "targets": 0 }, // checkbox tidak bisa sort
        { "orderable": false, "targets": -1 } // action tidak bisa sort
      ]
    });
    // Select all checkbox
    document.getElementById('selectAll').onclick = function() { 
      const checked = this.checked;
      document.querySelectorAll('.rowCheckbox').forEach(cb => cb.checked = checked);
    };
    // Filter logic dengan DataTable API (adopsi dari data_presensi.html)
    setTimeout(function() {
      $('#filterNamaSiswa').off('input').on('input', function() {
        dt.column(2).search(this.value).draw();
      });
      $('#filterGuruPembimbing').off('change').on('change', function() {
        var v = this.value;
        if (v) {
          dt.column(5).search('^'+v+'$', true, false).draw();
        } else {
          dt.column(5).search('').draw();
        }
      });
      $('#filterKelas').off('change').on('change', function() {
        var v = this.value;
        if (v) {
          dt.column(3).search('^'+v+'$', true, false).draw();
        } else {
          dt.column(3).search('').draw();
        }
      });
      $('#filterIndustri').off('change').on('change', function() {
        var v = this.value;
        if (v) {
          dt.column(6).search('^'+v+'$', true, false).draw();
        } else {
          dt.column(6).search('').draw();
        }
      });
      // Jalankan filter awal jika ada value
      if (filterNamaVal) dt.column(2).search(filterNamaVal).draw();
      if (filterGuruVal) dt.column(5).search('^'+filterGuruVal+'$', true, false).draw();
      if (filterKelasVal) dt.column(3).search('^'+filterKelasVal+'$', true, false).draw();
      if (filterIndustriVal) dt.column(6).search('^'+filterIndustriVal+'$', true, false).draw();
    }, 0);
  });
}
// Load data when page loads
document.addEventListener('DOMContentLoaded', loadData);

// Edit data function
function editData(id) {
  db.collection("siswa").doc(id).get().then((doc) => {
    if (doc.exists) {
      const data = doc.data();
      const params = new URLSearchParams({
        id: id,
        nis: data.nis || '',
        namaLengkap: data.namaLengkap || '',
        kelas: data.kelas || '',
        namaPerusahaan: data.namaPerusahaan || '',
        namaGuruPembimbing: data.namaGuruPembimbing || '',
        namaPembimbingIndustri: data.namaPembimbingIndustri || '',
        password: data.password || ''
      });
      window.location.href = `edit_siswa.html?${params.toString()}`;
    }
  });
}
// Delete data function
function deleteData(id) {
  if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
    db.collection("siswa").doc(id).delete()
      .then(() => {
        alert('Data berhasil dihapus!');
        loadData();
      })
      .catch((error) => {
        alert('Error: ' + error);
      });
  }
}
// Export Excel
document.getElementById('exportExcel').addEventListener('click', function() {
  db.collection("siswa").get().then((querySnapshot) => {
    const data = [];
    querySnapshot.forEach((doc) => {
      const d = doc.data();
      data.push({
        NIS: d.nis || '',
        Nama_Lengkap: d.namaLengkap || '',
        Kelas: d.kelas || '',
        Nama_Perusahaan: d.namaPerusahaan || '',
        Nama_Guru_Pembimbing: d.namaGuruPembimbing || '',
        Nama_Pembimbing_Industri: d.namaPembimbingIndustri || '',
        Password: d.password || ''
      });
    });
    /* global XLSX */
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Siswa");
    XLSX.writeFile(wb, "data_siswa.xlsx");
  });
});
// Refresh Data
document.getElementById('refreshData').addEventListener('click', function() {
  loadData();
});
// Logout function
function logout() {
  localStorage.removeItem('hasLoggedIn');
  window.location.href = 'login.html';
}
// Hapus massal
document.getElementById('deleteSelected').onclick = function() {
  const checked = Array.from(document.querySelectorAll('.rowCheckbox:checked'));
  if (checked.length === 0) {
    alert('Pilih data yang ingin dihapus!');
    return;
  }
  if (!confirm('Yakin ingin menghapus data terpilih?')) return;
  Promise.all(checked.map(cb => db.collection('siswa').doc(cb.getAttribute('data-id')).delete()))
    .then(() => {
      alert('Data terpilih berhasil dihapus!');
      loadData();
    });
};
</script>
</body>
</html>
