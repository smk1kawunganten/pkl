<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login Perusahaan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="hold-transition login-page">
  <div class="login-box">
    <div class="login-logo"><b>ePKL</b> Perusahaan</div>
    <div class="card">
      <div class="card-body login-card-body">
        <p class="login-box-msg">Login untuk Perusahaan</p>
        <form id="loginForm">
          <div class="form-group">
            <label for="programKeahlian">Program Keahlian</label>
            <select id="programKeahlian" class="form-control" required>
              <option value="">Pilih Program Keahlian</option>
              <option value="TKR">Teknik Kendaraan Ringan (TKR)</option>
              <option value="TSM">Teknik Sepeda Motor (TSM)</option>
              <option value="DKV">Desain Komunikasi Visual (DKV)</option>
              <option value="AN">Animasi (AN)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="perusahaan">Perusahaan</label>
            <select id="perusahaan" class="form-control" required>
              <option value="">Pilih Program Keahlian terlebih dahulu</option>
            </select>
          </div>
          <div class="row">
            <div class="col-12">
              <button type="submit" class="btn btn-primary btn-block">Login</button>
            </div>
          </div>
        </form>
        <div id="error" style="color:red; margin-top:10px;"></div>
        <div style="margin-top:10px; color:#555; font-size:13px;">
          Pilih program keahlian dan perusahaan yang sesuai dengan data PKL siswa.
        </div>
      </div>
    </div>
  </div>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDW5b9av9cBHh5AqEnxicBMIP0me-Goy_I",
      authDomain: "epkl-c628b.firebaseapp.com",
      projectId: "epkl-c628b",
      storageBucket: "epkl-c628b.firebasestorage.app",
      messagingSenderId: "41559318468",
      appId: "1:41559318468:web:3711f4da0f7087d683ce91",
      measurementId: "G-ZFWBRF40KQ"
    };
    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Load companies based on program keahlian
    document.getElementById('programKeahlian').addEventListener('change', function() {
      const programKeahlian = this.value;
      const perusahaanSelect = document.getElementById('perusahaan');
      
      if (!programKeahlian) {
        perusahaanSelect.innerHTML = '<option value="">Pilih Program Keahlian terlebih dahulu</option>';
        return;
      }

      console.log('Loading companies for program keahlian:', programKeahlian);
      
      // Query all students, filter by kelas yang mengandung kata kunci jurusan
      db.collection('siswa').get()
        .then(snapshot => {
          console.log('Total students found:', snapshot.size);
          const companies = new Set();
          
          snapshot.forEach(doc => {
            const data = doc.data();
            console.log('Student data:', data.nis, data.kelas, data.namaPerusahaan);
            
            // Cek apakah kelas mengandung kata kunci jurusan (case insensitive)
            if (data.kelas && data.kelas.toString().toUpperCase().includes(programKeahlian)) {
              console.log('Match found for student:', data.nis, 'kelas:', data.kelas, 'perusahaan:', data.namaPerusahaan);
              if (data.namaPerusahaan && data.namaPerusahaan.trim() !== '') {
                companies.add(data.namaPerusahaan.trim());
              }
            }
          });
          
          console.log('Companies found:', Array.from(companies));
          
          // Urutkan abjad
          const sortedCompanies = Array.from(companies).sort((a, b) => a.localeCompare(b));
          console.log('Sorted companies:', sortedCompanies);
          
          perusahaanSelect.innerHTML = '<option value="">Pilih Perusahaan</option>';
          sortedCompanies.forEach(company => {
            const option = document.createElement('option');
            option.value = company;
            option.textContent = company;
            perusahaanSelect.appendChild(option);
          });
          
          if (sortedCompanies.length === 0) {
            document.getElementById('error').innerText = 'Tidak ada perusahaan yang ditemukan untuk program keahlian ini.';
          } else {
            document.getElementById('error').innerText = '';
          }
        })
        .catch(err => {
          console.error('Error loading companies:', err);
          document.getElementById('error').innerText = 'Error loading companies: ' + err.message;
        });
    });

    document.getElementById('loginForm').onsubmit = function(e) {
      e.preventDefault();
      const programKeahlian = document.getElementById('programKeahlian').value;
      const perusahaan = document.getElementById('perusahaan').value;
      
      if (!programKeahlian || !perusahaan) {
        document.getElementById('error').innerText = 'Pilih program keahlian dan perusahaan!';
        return;
      }

      // Store login info and redirect
      localStorage.setItem('perusahaan_logged_in', 'true');
      localStorage.setItem('perusahaan_program_keahlian', programKeahlian);
      localStorage.setItem('perusahaan_nama', perusahaan);
      window.location.href = 'index.html';
    };
  </script>
</body>
</html> 